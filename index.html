<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PNGX Candlestick Charts</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#22d3ee}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
    header{padding:18px 20px;border-bottom:1px solid #1f2937;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    a{color:var(--accent);text-decoration:none}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .panel{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .controls{display:grid;grid-template-columns:1.4fr 1fr 1fr auto;gap:12px;align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input,button{width:100%;padding:10px 12px;border:1px solid #374151;border-radius:10px;background:#0b1220;color:var(--text)}
    button{cursor:pointer;border-color:#334155}
    button.primary{background:#0ea5e9;border-color:#0284c7;color:#001018}
    #status{font-size:12px;color:var(--muted);margin-top:8px;min-height:18px}
    #chart{background:var(--card);border:1px solid #1f2937;border-radius:16px;margin-top:16px}
    .footer{opacity:.7;font-size:12px;margin-top:10px;line-height:1.4}
  </style>
</head>
<body>
  <header>
    <h1>PNGX Candlestick Charts</h1>
    <div><a href="https://github.com/chrisaugu/pngx-api" target="_blank" rel="noreferrer">Powered by NUKU API</a></div>
  </header>

  <div class="container">
    <div class="panel">
      <div class="controls">
        <div>
          <label for="symbol">Symbol</label>
          <select id="symbol" size="1">
            <option value="">Select Stock</option>
          </select>
        </div>
        <div>
          <label for="start">Start date</label>
          <input type="date" id="start" />
        </div>
        <div>
          <label for="end">End date</label>
          <input type="date" id="end" />
        </div>
        <div>
          <button id="load" class="primary">Load chart</button>
        </div>
      </div>
      <div id="status"></div>
      <div id="chart"></div>
      <div class="footer">
        Site created by Neo Malesa. Data from the public API <a href="https://github.com/chrisaugu/pngx-api" target="_blank" rel="noreferrer">NUKU API</a> created by <a href="https://github.com/chrisaugu" target="_blank" rel="noreferrer">Chris August</a>. No warranties.
      </div>
    </div>
  </div>

  <script>
    const BASE = 'https://pngx-api.onrender.com/api/v2';
    const FALLBACK_SYMBOLS = ["BSP","CCP","CGA","CPL","KAM","KSL","NEM","NGP","NIU","SST","STO"];

    const selSymbol = document.getElementById('symbol');
    const inpStart  = document.getElementById('start');
    const inpEnd    = document.getElementById('end');
    const btnLoad   = document.getElementById('load');
    const statusEl  = document.getElementById('status');
    const chartEl   = document.getElementById('chart');

    const fmt = (d)=> d.toISOString().slice(0,10);
    function setStatus(msg){ statusEl.textContent = msg || ''; }

    (function initDates(){
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 30);
      inpStart.value = fmt(start);
      inpEnd.value   = fmt(end);
    })();

    async function loadSymbols(){
      try{
        const r = await fetch(`${BASE}/tickers`, { cache: 'no-store' });
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const json = await r.json();
        let syms = [];
        if(Array.isArray(json?.symbols)) syms = json.symbols;
        else if(Array.isArray(json?.tickers)) syms = json.tickers.map(x=> x.symbol || x.code || x.ticker).filter(Boolean);
        else if(Array.isArray(json)) syms = json.map(x=> x.symbol || x.code).filter(Boolean);
        if(!syms.length) syms = FALLBACK_SYMBOLS;
        syms = syms.sort();
        populateSymbols(syms);
      }catch(err){
        console.warn('Failed to load symbols, using fallback.', err);
        const sortedFallback = [...FALLBACK_SYMBOLS].sort();
        populateSymbols(sortedFallback);
        setStatus('Loaded fallback symbol list.');
      }
    }

    function populateSymbols(list){
      list.forEach(sym => {
        const opt = document.createElement('option');
        opt.value = sym;
        opt.textContent = sym;
        selSymbol.appendChild(opt);
      });
      selSymbol.disabled = false;
    }

    async function fetchOHLC(symbol, start, end){
      const url = `${BASE}/historicals/${encodeURIComponent(symbol)}?start=${start}&end=${end}`;
      const r = await fetch(url, { cache: 'no-store' });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      if(!Array.isArray(data)) return [];
      return data
        .map(d => ({
          t: d.t || d.time || d.date,
          o: num(d.o), h: num(d.h), l: num(d.l), c: num(d.c)
        }))
        .filter(d => isFinite(d.o) && isFinite(d.h) && isFinite(d.l) && isFinite(d.c) && d.t)
        .map(d => ({ x: new Date(d.t), y: [d.o, d.h, d.l, d.c] }));
    }

    function num(x){
      const n = typeof x === 'string' ? Number(x) : x;
      return Number.isFinite(n) ? n : NaN;
    }

    let chart;
    function ensureChart(){
      if(chart) return chart;
      const options = {
        chart: { type: 'candlestick', height: 520, animations: { enabled: false }, toolbar: { show: true } },
        theme: { mode: 'dark' },
        series: [{ name: 'OHLC', data: [] }],
        xaxis: { type: 'datetime' },
        yaxis: { tooltip: { enabled: true } },
        noData: { text: 'No data' },
        tooltip: { shared: false }
      };
      chart = new ApexCharts(chartEl, options);
      chart.render();
      return chart;
    }

    async function loadChart(){
      const symbol = selSymbol.value;
      const start  = inpStart.value;
      const end    = inpEnd.value;
      if(!symbol || !start || !end){ setStatus('Please select symbol and dates.'); return; }
      setStatus('Loading…');
      try{
        ensureChart();
        const series = await fetchOHLC(symbol, start, end);
        if(!series.length){
          chart.updateSeries([{ name: symbol, data: [] }], true);
          setStatus('No data returned for the selected range.');
          return;
        }
        chart.updateSeries([{ name: symbol, data: series }], true);
        setStatus(`${symbol} · ${start} → ${end} · ${series.length} candles`);
      }catch(err){
        console.error(err);
        setStatus('Failed to load data. Try a different date range.');
      }
    }

    btnLoad.addEventListener('click', loadChart);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadChart(); });

    (async function(){
      selSymbol.disabled = true;
      await loadSymbols();
      selSymbol.disabled = false;
    })();
  </script>
</body>
</html>
